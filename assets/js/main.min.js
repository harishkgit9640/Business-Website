$(document).ready(function () {
  function i() {
    window.innerWidth < 1024
      ? $("#sidebar").css({ left: "-300px" }).addClass("hidden")
      : $("#sidebar").css({ left: "0px" }).removeClass("hidden");
  }
  AOS.init({ duration: 800, once: !0 }),
    i(),
    $(window).on("resize", function () {
      i();
    }),
    $("#menu-btn").on("click", function () {
      window.innerWidth < 1024 &&
        ($("#sidebar").hasClass("hidden")
          ? $("#sidebar").removeClass("hidden").animate({ left: "0px" }, 300)
          : $("#sidebar").animate({ left: "-300px" }, 300, function () {
              $(this).addClass("hidden");
            }));
    }),
    $(document).on("click", function (i) {
      window.innerWidth < 1024 &&
        !$(i.target).closest("#sidebar, #menu-btn").length &&
        $("#sidebar").animate({ left: "-300px" }, 300, function () {
          $(this).addClass("hidden");
        });
    }),
    $("#servicesList").on("click", "a", function (i) {
      var [s, t] = $(this).attr("href").split("#");
      window.location.pathname.split("/").pop() === s &&
        (i.preventDefault(), (s = $("#" + t)).length) &&
        ($("#servicesList li.sub_nav_link").removeClass("active"),
        $(this).closest("li.sub_nav_link").addClass("active"),
        history.pushState(null, null, "#" + t),
        $("html, body").animate({ scrollTop: s.offset().top - 150 }, 700),
        window.innerWidth < 1024) &&
        $("#sidebar").animate({ left: "-300px" }, 300, function () {
          $(this).addClass("hidden");
        });
    });
  const n = window.location.href;
  var s, t;
  $("#sidebar a").each(function () {
    var i = this.href,
      s = this.hash,
      t = n.split("#")[0],
      e = i.split("#")[0];
    (i === n || (s && -1 !== n.indexOf(s)) || (e === t && !s)) &&
      $(this).closest("li").addClass("active");
  }),
    $("#servicesList").on("click", "a", function (i) {
      var [s, t] = $(this).attr("href").split("#");
      window.location.pathname.split("/").pop() === s &&
        (i.preventDefault(), (s = $("#" + t)).length) &&
        ($("#servicesList li.sub_nav_link").removeClass("active"),
        $(this).closest("li.sub_nav_link").addClass("active"),
        history.pushState(null, null, "#" + t),
        $("html, body").animate({ scrollTop: s.offset().top - 150 }, 700));
    }),
    (t = window.location.hash) &&
      (s = $(t)).length &&
      ($("#servicesList li.sub_nav_link").removeClass("active"),
      $("#servicesList a[href$='" + t + "']")
        .closest("li.sub_nav_link")
        .addClass("active"),
      $("html, body").animate({ scrollTop: s.offset().top - 150 }, 700));
}),
  $(document).on("click", ".learn-more-btn", function () {
    var i = $(this).data("target");
    const s = $("." + i);
    i = $(this).find("svg");
    s.hasClass("hidden")
      ? (s.hide().removeClass("hidden").slideDown(300),
        $(this).find("span").text("Show less"),
        i.addClass("rotate-180"))
      : (s.slideUp(300, () => {
          s.addClass("hidden");
        }),
        $(this).find("span").text("Learn more"),
        i.removeClass("rotate-180"));
  });


//  Image View Modal =======

$("#image_wrapper img").on("click", function () {
    $("#full-image").attr("src", $(this).attr("src"));
    $("#image-viewer").fadeIn(200);
});

// Close button
$("#image-viewer .close").on("click", function () {
    closeImageViewer();
});

// ESC key to close
$(document).on("keydown", function (e) {
    if (e.key === "Escape") {
        closeImageViewer();
    }
});

// Click outside modal image to close
$(document).on("click", function (e) {
    const viewer = $("#image-viewer");
    const content = $("#image-viewer .modal-content");

    // If modal is open AND clicked outside modal-content AND not clicking gallery images
    if (
        viewer.is(":visible") &&
        !$(e.target).closest(content).length &&
        !$(e.target).closest("#image_wrapper img").length
    ) {
        closeImageViewer();
    }
});

// Central close function
function closeImageViewer() {
    $("#image-viewer").fadeOut(200);
}

// User cookie-consent preferences.
$(document).ready(function () {

    const storageKey = 'TERMLY_COOKIE_CONSENT';
    const cookieName = 'TERMLY_COOKIE_CONSENT';
    const modal = $('.cookie-consent-modal');


// "true" means the cookie category is allowed,
// "false" means the category is denied.
// "necessary" is always true because the site cannot function without it.

    let prefs = {
        necessary: true,
        functional: false,
        analytics: false,
        marketing: false
    };

    let saved = null;

    // Helper: set cookie
    function setCookie(name, value, days = 365) {
        const maxAge = days * 24 * 60 * 60;
        document.cookie = `${name}=${value}; path=/; max-age=${maxAge}; SameSite=Lax`;
    }

    // Helper: get cookie
    function getCookie(name='TERMLY_COOKIE_CONSENT') {
        const match = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return match ? match.pop() : null;
    }

    // Hide initially
    modal.addClass("opacity-0");

    // STEP 1 – Try cookie
    const cookiePrefs = getCookie(cookieName);
    if (cookiePrefs) {
        try {
            saved = JSON.parse(cookiePrefs);
        } catch (e) {
            console.warn("Invalid cookie JSON");
        }
    }

    // STEP 2 – Try localStorage if cookie missing
    if (!saved && localStorage.getItem(storageKey)) {
        try {
            saved = JSON.parse(localStorage.getItem(storageKey));
        } catch (e) {
            console.warn("Invalid localStorage JSON");
        }
    }

    const checkboxes = $('input[type="checkbox"]').not(':disabled');

    // STEP 3 – If we found saved prefs, apply them
    if (saved) {
        checkboxes.each(function () {
            const value = $(this).val().trim();
            $(this).prop("checked", saved[value] || false);
        });

        // Necessary is always forced true
        $('input[value="necessary"]').prop("checked", true);

        modal.addClass("hidden");
    } else {
        // No saved prefs → show modal
        setTimeout(() => {
          modal.removeClass("opacity-0")
          modal.removeClass("hidden")
        }, 500);
    }

    // Save preferences (from user interaction)
    function savePreferences(allowAll = false) {

        checkboxes.each(function () {
            const value = $(this).val().trim();
            prefs[value] = allowAll ? true : $(this).is(":checked");
        });

        // Force necessary true
        prefs.necessary = true;

        // Save to both
        localStorage.setItem(storageKey, JSON.stringify(prefs));
        setCookie(cookieName, JSON.stringify(prefs));

        modal.addClass("hidden");
    }

    $(".decline-all").on("click", function () {
        checkboxes.prop("checked", false);
        $('input[value="necessary"]').prop("checked", true);
        savePreferences(false);
    });

    $(".allow-all").on("click", function () {
        checkboxes.prop("checked", true);
        savePreferences(true);
    });

    $(".cookie-close").on("click", function () {
         checkboxes.each(function () {
            const value = $(this).val().trim();
            prefs[value] = $(this).is(":checked") ? true : false ;
        });

        // Force necessary true
        prefs.necessary = true;

        // Save to both
        localStorage.setItem(storageKey, JSON.stringify(prefs));
        setCookie(cookieName, JSON.stringify(prefs));

        modal.addClass("hidden");
    });

});
